{% extends 'sherlock/_layouts/tests' %}

{% set title = 'Sherlock' %}
{% set faIcons = {
    'fail': 'fas fa-times-circle',
    'pass': 'fas fa-check-square',
    'warning': 'fas fa-exclamation-triangle',
    'code': 'fas fa-code',
    'files': 'far fa-copy',
    'folder': 'far fa-folder',
    'plugin': 'fas fa-plug',
    'secure': 'fas fa-lock',
    'server': 'fas fa-server',
    'settings': 'fas fa-cog',
    'upload': 'fas fa-upload',
    'user': 'fas fa-user',
} %}

{% set bundle = view.registerAssetBundle("putyourlightson\\sherlock\\assets\\SherlockAsset") %}
{% set resourcesUrl = bundle.baseUrl %}


{% block content %}

    {% set allScans = craft.sherlock.getAllScans() %}

    {% if allScans|length %}

        {% set lastScan = allScans[0] %}

        <div class="sherlock">
            <div class="buttons right">
                <a href="#" class="btn submit run-scan" data-url="{{ actionUrl('sherlock/ajax/run-scan') }}">{{ "Run Scan Now"|t('sherlock') }}</a>
            </div>

            <h1 class="title">{{ "Last Security Scan"|t('sherlock') }}</h1>
            <h2>
                <i class="fas fa-history"></i>
                {{ lastScan.dateCreated|date('j F Y \\a\\t H:i') }}
            </h2>

            <h1>
                <i class="{{ faIcons[lastScan.pass ? 'pass' : 'fail'] }} {{ lastScan.pass ? 'pass' : 'fail' }}" title="{{ (lastScan.pass ? 'Pass' : 'Fail')|t('sherlock') }}"></i>&nbsp;
                <span>This site <strong>{{ lastScan.pass ? 'pass' : 'fail' }}ed</strong> the <strong>{{ craft.sherlock.isHighSecurityLevel ? 'high' : 'standard' }}</strong> security scan {{ lastScan.pass and lastScan.warning ? ' with <strong>warnings</strong>'|raw }}</span>
                <span class="info">{{ "This security scan result is determined by a set of criteria used by Sherlock's standard/high security level setting. This is only a guideline and cannot ensure that your site and server are 100% secure. The security of this site is solely the responsibility of the site owner."|t('sherlock') }}</span>
            </h1>

            <table class="data fullwidth results">
                <thead>
                    <tr>
                        <th></th>
                        <th>{{ "Test"|t('sherlock') }}</th>
                        <th>{{ "Details"|t('sherlock') }}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for resultType, results in lastScan.results %}
                        {% for testName, value in results %}
                            {% if tests[testName] is defined %}
                                {% set test = tests[testName] %}
                                <tr>
                                    <td>
                                        <i class="{{ faIcons[resultType] }} {{ resultType }}" title="{{ resultType|capitalize }}"></i>
                                    </td>
                                    <td>
                                        <i class="{{ faIcons[test.type] }} type" title="{{ test.typeName|t('sherlock') }}"></i>
                                        <span class="{{ resultType == 'fail' ? 'fail' }}">{{ test.name|t('sherlock') }}</span>
                                    </td>
                                    <td>
                                        <span class="result {{ resultType == 'fail' ? 'fail' }}">
                                            {% if resultType == 'pass' %}
                                                {{ test.details.pass|t('sherlock')|raw }}
                                            {% elseif resultType == 'warning' %}
                                                {{ test.details.warning|t('sherlock')|raw }}
                                            {% else %}
                                                {{ (test.details.fail is defined ? test.details.fail : test.details.warning)|t('sherlock')|raw }}
                                            {% endif %}
                                            {% if value %}
                                                {{ test.safeValue is defined and test.safeValue ? value|raw : value }}
                                            {% endif %}
                                        </span>
                                        {% if test.info and not (testName == 'pluginVulnerabilities' and resultType == 'fail') %}
                                            <span class="info">{{ test.info|nl2br }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if test.link is defined %}
                                            <a href="{{ test.link.url }}" class="go" target="_blank">{{ test.link.label|t('sherlock') }}</a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>

            <div class="buttons right">
                <a href="#" class="btn submit run-scan" data-url="{{ actionUrl('ajax/run-scan') }}">{{ "Run Scan Now"|t('sherlock') }}</a>
            </div>

            <h1 class="title">{{ "Security Scan History"|t('sherlock') }}</h1>
            <h2><i class="fas fa-history"></i> {{ "Previously run security scans"|t('sherlock') }}</h2>

            <table class="data fullwidth limited" data-limit="10">
                <thead>
                    <tr>
                        <th></th>
                        <th>{{ "Result"|t('sherlock') }}</th>
                        <th>{{ "Security Level"|t('sherlock') }}</th>
                        <th>{{ "Failed Tests"|t('sherlock') }}</th>
                        <th>{{ "Warnings"|t('sherlock') }}</th>
                        <th>{{ "Date"|t('sherlock') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in allScans %}
                        <tr>
                            <td>
                                <i class="{{ faIcons[scan.pass ? 'pass' : 'fail'] }} {{ scan.pass ? 'pass' : 'fail' }}" title="{{ (scan.pass ? 'Pass' : 'Fail')|t('sherlock') }}"></i>
                            </td>
                            <td>{{ scan.pass ? 'Pass' ~ (scan.warning ? ' with warnings') : 'Fail' }}</td>
                            <td>{{ scan.highSecurityLevel ? 'High' : 'Standard' }}</td>
                            <td>{{ scan.results.fail is defined ? scan.results.fail|length : 0 }}</td>
                            <td>{{ scan.results.warning is defined ? scan.results.warning|length : 0 }}</td>
                            <td>{{ scan.dateCreated|date('j F Y \\a\\t H:i') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="expand" style="display: none;">
                <a class="view-more" href="#">{{ 'View full scan history'|t('sherlock') }}<strong class="caret"></strong></a>
                <a class="view-less dropup" href="#" style="display: none;">{{ 'View less scan history'|t('sherlock') }}<strong class="caret up"></strong></a>
            </div>
        </div>

    {% else %}

        <script>var runScan = '{{ actionUrl('sherlock/ajax/run-scan') }}';</script>

    {% endif %}

    <div class="running" {{ allScans|length ? 'style="display: none;"' }}>
        <div id="graphic" class="spinner big"></div>
        <div id="status"><p>{{ "Running security scanâ€¦"|t('sherlock') }}</p></div>
    </div>

{% endblock %}

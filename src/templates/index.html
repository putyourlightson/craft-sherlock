{% extends "sherlock/_tests" %}

{% includeCssResource "sherlock/css/style.css" %}
{% includeCssResource "css/updates.css" %}
{% includeJsResource "sherlock/js/script.js" %}

{% set title = craft.sherlock.pluginName %}
{% set faIcons = {'header': 'fa-lock', 'server': 'fa-server', 'upload': 'fa-upload', 'folder': 'fa-folder-o', 'files': 'fa-files-o', 'code': 'fa-code'} %}


{% block content %}

    {% set allScans = craft.sherlock.allScans %}

    {% if allScans|length %}

        {% set lastScan = allScans[0] %}

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

        <div class="sherlock">
            <div class="buttons right">
                <a href="#" class="btn submit run-scan" data-url="{{ actionUrl('sherlock/runScanAjax') }}">{{ "Run Scan Now"|t }}</a>
            </div>

            <h1 class="title">{{ "Last Security Scan"|t }}</h1>
            <h2>
                <i class="fa fa-clock-o"></i>
                {{ lastScan.dateCreated|date('j F Y \\a\\t H:i') }}
            </h2>

            <h1>
                <img width="32" height="32" src="{{ resourceUrl('sherlock/icons/' ~ (lastScan.pass ? 'pass' : 'fail') ~ '.svg') }}" />
                This site <strong>{{ lastScan.pass ? 'pass' : 'fail' }}ed</strong> the <strong>{{ craft.sherlock.checkHighSecurityLevel ? 'high' : 'standard' }}</strong> security scan {{ lastScan.pass and lastScan.warning ? ' with <strong>warnings</strong>'|raw }}
                <span class="info">{{ "This security scan result is determined by a set of criteria used by Sherlock's standard/high security level setting. This is only a guideline and cannot ensure that your site and server are 100% secure. The security of this site is solely the responsibility of the site owner."|t }}</span>
            </h1>

            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th></th>
                        <th>{{ "Test"|t }}</th>
                        <th>{{ "Details"|t }}</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for resultType, results in lastScan.results %}
                    {% for testName, value in results %}
                        {% set test = tests[testName] %}
                        <tr>
                            <td>
                                <img src="{{ resourceUrl('sherlock/icons/' ~ resultType ~ '.svg') }}" title="{{ resultType|capitalize }}" />
                            </td>
                            <td>
                                <span class="{{ resultType == 'fail' ? 'fail' }}">{{ test.name|t }}</span>
                                {% if faIcons[test.type] is defined %}
                                    <i class="type fa {{ faIcons[test.type] }}" title="{{ test.typeName|t }}"></i>
                                {% else %}
                                    <i class="type" data-icon="{{ test.type }}" title="{{ test.typeName|t }}"></i>
                                {% endif %}
                            </td>
                            <td>
                                <span class="result {{ resultType == 'fail' ? 'fail' }}">
                                    {% if resultType == 'pass' %}
                                        {{ test.details.pass|t|raw }}
                                    {% elseif resultType == 'warning' %}
                                        {{ test.details.warning|t|raw }}
                                    {% else %}
                                        {{ (test.details.fail is defined ? test.details.fail : test.details.warning)|t|raw }}
                                    {% endif %}
                                    {{ value ? value|raw }}
                                </span>
                                {% if test.info and not (testName == 'pluginVulnerabilities' and resultType == 'fail') %}
                                    <span class="info">{{ test.info|t|raw }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if test.url is defined %}
                                    <a href="{{ test.url }}" class="go" target="_blank">{{ "Docs"|t }}</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>

            <br/><br/><br/>

            <div class="buttons right">
                <a href="#" class="btn submit run-scan" data-url="{{ actionUrl('sherlock/runScanAjax') }}">{{ "Run Scan Now"|t }}</a>
            </div>

            <h1 class="title">{{ "Security Scan History"|t }}</h1>
            <h2><i class="fa fa-history"></i> {{ "Previously run security scans"|t }}</h2>

            <table class="data fullwidth limited" data-limit="10">
                <thead>
                    <tr>
                        <th></th>
                        <th>{{ "Result"|t }}</th>
                        <th>{{ "Security Level"|t }}</th>
                        <th>{{ "Failed Tests"|t }}</th>
                        <th>{{ "Warnings"|t }}</th>
                        <th>{{ "Date"|t }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in allScans %}
                        <tr>
                            <td><img src="{{ resourceUrl('sherlock/icons/' ~ (scan.pass ? 'pass' : 'fail') ~ '.svg') }}" /></td>
                            <td>{{ scan.pass ? 'Pass' ~ (scan.warning ? ' with warnings') : 'Fail' }}</td>
                            <td>{{ scan.highSecurityLevel ? 'High' : 'Standard' }}</td>
                            <td>{{ scan.results.fail is defined ? scan.results.fail|length : 0 }}</td>
                            <td>{{ scan.results.warning is defined ? scan.results.warning|length : 0 }}</td>
                            <td>{{ scan.dateCreated|date('j F Y \\a\\t H:i') }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="expand" style="display: none;">
                <a class="view-more" href="#">View all scan history<b class="caret"></b></a>
                <a class="view-less dropup" href="#" style="display: none;">View less scan history<b class="caret up"></b></a>
            </div>
        </div>

    {% else %}

        <script>var runScanAjax = '{{ actionUrl('sherlock/runScanAjax') }}';</script>

    {% endif %}

    <div class="running" {{ allScans|length ? 'style="display: none;"' }}>
    	<div id="graphic" class="spinner big"></div>
    	<div id="status">{{ "Running security scanâ€¦"|t }}</div>
    </div>

{% endblock %}
